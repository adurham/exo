name: Deploy to Home Cluster

on:
  push:
    branches:
      - local_mac_cluster
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, exo-deployer]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to All Nodes
        run: |
          # --- CONFIGURATION ---
          NODES=("192.168.86.100" "192.168.86.101" "192.168.86.103")
          SSH_USER="adam.durham"
          
          for NODE in "${NODES[@]}"; do
            echo "------------------------------------------------"
            echo "üì° Connecting to $NODE..."
            ssh -o StrictHostKeyChecking=no "$SSH_USER@$NODE" 'bash -s' < scripts/deploy_node.sh
          done

      # --- NEW STEP 1: Verify UI is Up ---
      - name: üè• Health Check (Head Node UI)
        run: |
          HEAD_IP="192.168.86.100"
          PORT="52415"
          MAX_RETRIES=30  # 30 * 5s = 2.5 minutes timeout
          
          echo "‚è≥ Waiting for Exo UI to respond at http://$HEAD_IP:$PORT..."
          
          count=0
          # Loop until '200 OK' is found
          until curl -s --head --request GET "http://$HEAD_IP:$PORT" | grep "200 OK" > /dev/null; do
            if [ $count -eq $MAX_RETRIES ]; then
              echo "‚ùå Timeout: Web UI never came online."
              exit 1
            fi
            printf "."
            sleep 5
            count=$((count+1))
          done
          
          echo ""
          echo "‚úÖ Head Node UI is Online!"

      # --- NEW STEP 2: Verify All Nodes Connected ---
      - name: üïµÔ∏è Verify Cluster Topology (Api Check)
        run: |
          HEAD_IP="192.168.86.100"
          PORT="52415"
          EXPECTED_NODES=3
          
          echo "üîç Querying API for connected devices..."
          
          # Fetch the raw JSON from the API
          API_RESPONSE=$(curl -s "http://$HEAD_IP:$PORT/state")
          
          # Debug: Print it so you can see what happened if it fails
          echo "Raw API Response: $API_RESPONSE"
          
          # Parse the JSON to count the devices list
          NODE_COUNT=$(echo "$API_RESPONSE" | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('topology', {}).get('nodes', [])))")
          
          echo "üìä Active Nodes Found: $NODE_COUNT"
          
          if [ "$NODE_COUNT" -lt "$EXPECTED_NODES" ]; then
            echo "‚ö†Ô∏è Warning: Expected $EXPECTED_NODES nodes but only found $NODE_COUNT."
            # Uncomment the next line to FAIL the build if a node is missing
            # exit 1 
          else
            echo "‚úÖ Full Cluster is Healthy!"
          fi